<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/static/images/Tux.svg.png" />
    <title>CMDB Overview</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="/static/css/datatables/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="/static/css/datatables/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="/static/css/datatables/datatables.css" />
    <link rel="stylesheet" href="/static/css/datatables/select.dataTables.min.css" />

    <!-- Other CSS -->
    <link rel="stylesheet" href="/static/css/select2/select2.min.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="stylesheet" href="/static/css/charts/charts.css" />
    

    <!-- CSS Overwrite  -->
    <link rel="stylesheet" href="/config/custom.css" />


    <!-- JavaScript Libraries -->
    <script src="/static/js/jquery/jquery-3.7.0.min.js"></script>
    <script src="/static/js/jquery/jquery.dataTables.min.js"></script>
    <script src="/static/js/datatabels/dataTables.buttons.min.js"></script>
    <script src="/static/js/datatables/buttons.html5.min.js"></script>
    <script src="/static/js/datatables/buttons.colVis.min.js"></script>
    <script src="/static/js/datatables/jszip.min.js"></script>
    <script src="/static/js/select2/select2.min.js"></script>
    <script src="/static/js/charts/chart.js"></script>
    <script src="/static/js/datatables/dataTables.select.min.js"></script>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="/static/images/Tux.svg.png" alt="Tux Linux Mascot" />
            </div>
            <h1>Ansible CMDB</h1>
        </div>
    </header>

    <main>
        <div class="charts-container">
            <div class="chart-section">
                <div class="chart-title">Operating System Distribution</div>
                <canvas id="osChart"></canvas>
                <button class="clear-filters" onclick="clearOsFilter()">Clear OS Filter</button>
            </div>
            <div class="chart-section">
                <div class="chart-title">OS Versions</div>
                <table class="version-table" id="versionTable">
                    <thead>
                        <tr>
                            <th>OS Family</th>
                            <th>Version</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
                <button class="clear-filters" onclick="clearVersionFilter()">Clear Version Filter</button>
            </div>
        </div>

        <button id="reset-filters">ðŸ”„ Reset all filters</button>

        <h2 class="content-heading">CMDB Content</h2>
        <hr></hr>

        <div id="selection-info">
            <span id="selected-count">0 rows selected</span>
            <button id="clear-selection">Clear Selection</button>
        </div>

        <table id="cmdbTable" class="display nowrap">
            <thead>
                <tr class="header-row">
                    <!-- Dynamic headers will be inserted here by JavaScript -->
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <!-- Filter inputs will be added here by JavaScript -->
                </tr>
            </tfoot>
            <tbody>
                {% for item in items %}
                <tr>
                    <!-- Dynamic data cells will be inserted here by JavaScript -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <div class="footer">
        <p>Made by Guido Martens</p>
    </div>

    <!-- Template data -->
    <script type="application/json" id="table-data">
        {{ items|tojson|safe }}
    </script>

    <!-- Application JavaScript -->
    <script src="/static/js/datatables/table-utils.js"></script>
    <script src="/config/columns.js"></script>
    <script src="/static/js/datatables/datatables-init.js"></script>
    <script src="/static/js/charts/charts-init.js"></script>
    <script>
        let selectedOs = null;
        let selectedVersion = null;

        function clearOsFilter() {
            selectedOs = null;
            selectedVersion = null;
            mainTable.column(1).search('').draw();
            document.querySelectorAll('#versionTable tr').forEach(r => r.classList.remove('selected'));
            updateCharts(JSON.parse(document.getElementById('table-data').textContent));
        }

        function clearVersionFilter() {
            selectedVersion = null;
            if (selectedOs) {
                mainTable.column(1).search(`^${selectedOs}$`, true, false).column(2).search('').draw();
            } else {
                mainTable.column(1).search('').column(2).search('').draw();
            }
            document.querySelectorAll('#versionTable tr').forEach(r => r.classList.remove('selected'));
            updateCharts(JSON.parse(document.getElementById('table-data').textContent));
        }

        $(document).ready(function () {
            const tableData = JSON.parse(document.getElementById('table-data').textContent);
            initializeDataTable(tableData);
            updateCharts(tableData);
        });
    </script>
</body>
</html>
