<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/static/images/Tux.svg.png" />
    <title>CMDB Overview</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="/static/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="/static/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css" />
    
    <!-- Other CSS -->
    <link rel="stylesheet" href="/static/css/select2.min.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="stylesheet" href="/static/css/charts.css" />
    <link rel="stylesheet" href="/static/css/datatables.css" />
    <link rel="stylesheet" href="/config/custom.css" />

    <!-- JavaScript Libraries -->
    <script src="/static/js/jquery-3.7.0.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.buttons.min.js"></script>
    <script src="/static/js/buttons.html5.min.js"></script>
    <script src="/static/js/buttons.colVis.min.js"></script>
    <script src="/static/js/jszip.min.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="/static/images/Tux.svg.png" alt="Tux Linux Mascotte" />
            </div>
            <h1>Ansible CMDB</h1>
        </div>
    </header>

    <main>
        <div class="charts-container">
            <div class="chart-section">
                <div class="chart-title">Operating System Distribution</div>
                <canvas id="osChart"></canvas>
                <button class="clear-filters" onclick="clearOsFilter()">Clear OS Filter</button>
            </div>
            <div class="chart-section">
                <div class="chart-title">OS Versions</div>
                <table class="version-table" id="versionTable">
                    <thead>
                        <tr>
                            <th>OS Family</th>
                            <th>Version</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
                <button class="clear-filters" onclick="clearVersionFilter()">Clear Version Filter</button>
            </div>
        </div>

        <button id="reset-filters">ðŸ”„ Reset all filters</button>

        <h2>CMDB Content</h2>
        <hr></hr>
        <label for="rows-per-page">ðŸ“„ Regels per pagina:</label>
        <select id="rows-per-page">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="250">250</option>
            <option value="500">500</option>
        </select>

        <div id="selection-info">
            <span id="selected-count">0 rijen geselecteerd</span>
            <button id="clear-selection" style="margin-left: 10px;">Selectie wissen</button>
        </div>

        <table id="cmdbTable" class="display nowrap">
            <thead>
                <tr class="header-row">
                    <!-- Dynamic headers will be inserted here by JavaScript -->
                </tr>
                <tr class="filter-row">
                    <!-- Dynamic filter cells will be inserted here by JavaScript -->
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <!-- Dynamic data cells will be inserted here by JavaScript -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <div class="footer">
        <p>Made by Guido Martens</p>
    </div>

    <!-- Template data -->
    <script type="application/json" id="table-data">
        {{ items|tojson|safe }}
    </script>

    <!-- Application JavaScript -->
    <script src="/config/columns.js"></script>
    <script src="/static/js/datatables-init.js"></script>
    <script src="/static/js/charts-init.js"></script>
    <script>
        let osChart;
        let selectedOs = null;
        let selectedVersion = null;

        function clearOsFilter() {
            selectedOs = null;
            selectedVersion = null;
            mainTable.column(1).search('').draw();
            document.querySelectorAll('#versionTable tr').forEach(r => r.classList.remove('selected'));
            updateCharts();
        }

        function clearVersionFilter() {
            selectedVersion = null;
            if (selectedOs) {
                mainTable.column(1).search(`^${selectedOs}$`, true, false).column(2).search('').draw();
            } else {
                mainTable.column(1).search('').column(2).search('').draw();
            }
            document.querySelectorAll('#versionTable tr').forEach(r => r.classList.remove('selected'));
            updateCharts();
        }

        $(document).ready(function () {
            const tableData = JSON.parse(document.getElementById('table-data').textContent);
            initializeDataTable(tableData);
            updateCharts(tableData);

            // Handle rows per page change
            $('#rows-per-page').on('change', function () {
                const val = parseInt($(this).val(), 10);
                mainTable.page.len(val).draw();
            });
        });
    </script>

    <style>
    /* Add styling for selected rows */
    table.dataTable tbody tr.selected {
        background-color: #b0bed9 !important;
    }
    
    /* Add styling for selection info */
    #selection-info {
        margin: 10px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: none;
    }
    </style>
</body>
</html>
